version: '3.4'

services:
  redis:
    restart: always
    image: redis:3.0.7-alpine
    container_name: redis

  postgresql:
    restart: always
    image: postgres:9.6.2-alpine
    container_name: postgresql
    environment:
      - POSTGRES_USER=gitlab
      - POSTGRES_PASSWORD=gitlab
      - POSTGRES_DB=gitlabhq_production
    volumes:
      - ./postgresql/conf:/var/lib/postgresql

  gitlab:
    restart: always
    image: gitlab/gitlab-ce:9.1.0-ce.0
    hostname: 'gitlab.example.com'
    container_name: gitlab
    links:
      - postgresql:postgresql
      - redis:redis
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        postgresql['enable'] = false
        gitlab_rails['db_username'] = "gitlab"
        gitlab_rails['db_password'] = "gitlab"
        gitlab_rails['db_host'] = "postgresql"
        gitlab_rails['db_port'] = "5432"
        gitlab_rails['db_database'] = "gitlabhq_production"
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        redis['enable'] = false
        gitlab_rails['redis_host'] = 'redis'
        gitlab_rails['redis_port'] = '6379'
        external_url 'http://gitlab.example.com:30080'
        gitlab_rails['gitlab_shell_ssh_port'] = 30022
    ports:
      - "$gitlab_port:30080"
      - "30022:30022"
    volumes:
      - ./gitlab/conf/config:/etc/gitlab
      - ./gitlab/conf/logs:/var/log/gitlab
      - ./gitlab/conf/data:/var/opt/gitlab

  jenkins:
    restart: always
    build:
      context: ./jenkins
      args:
        - external_mounts_path=$external_mounts_path
        - jenkins_home_path=$jenkins_home_path
        - jenkins_init_groovy_path=$jenkins_init_groovy_path
    container_name: jenkins
    expose:
      - "8080"
    ports:
      - "$jenkins_port:8080"
    depends_on:
      - gitlab
    volumes:
      - ./jenkins/mounts:$external_mounts_path
      - ./jenkins/conf:/var/jenkins_home
    environment:
      - jenkins_user=$jenkins_user
      - jenkins_pass=$jenkins_pass
      - jenkins_home_path=$jenkins_home_path
      - external_mounts_path=$external_mounts_path
      - jenkins_add_credential_filename=$jenkins_add_credential_filename
    stdin_open: true
    tty: true

  docserver:
    restart: always
    build: ./docserver
    container_name: docserver
    expose:
      - 3000
    ports:
      - "$docserver_port:3000"
    volumes:
      - ./docserver/mounts:$external_mounts_path
    stdin_open: true
    tty: true
